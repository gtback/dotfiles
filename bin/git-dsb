#!/bin/bash

# Delete branches that have been squash-merged into the remote HEAD branch
# (usually `main` or `master`).

# From: https://github.com/not-an-aardvark/git-delete-squashed

# Run with `git dsb`

set -euo pipefail

git checkout -q remotes/origin/HEAD && git for-each-ref refs/heads/ "--format=%(refname:short)" |
    while read -r branch; do
        mergeBase=$(git merge-base remotes/origin/HEAD "$branch") &&
            [[ $(git cherry remotes/origin/HEAD "$(git commit-tree "$(git rev-parse "$branch"^\{tree\})" -p "$mergeBase" -m _)") == "-"* ]] &&
            git branch -D "$branch"
    done
